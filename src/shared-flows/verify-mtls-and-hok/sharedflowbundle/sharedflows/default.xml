<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<SharedFlow name="default">
    <Step>
        <Name>KVM-GetMTLSHostname</Name>
    </Step>
    <Step>
        <Name>JS-CheckIfHostHeaderMatchesMTLSHostname</Name>
    </Step>
    <Step>
        <Name>RF-NonMTLS</Name>
        <!-- In a production environment make sure to add an entry to the CDSConfig KVM with key = "HOK_enforceMTLSOnly"
             and value = "true" to ensure that this check is always enforced.
             In a non-production environment, endpoints can also associated with the default non-mtls hostname, 
             and that enables a test environment without HoK enforcement 
        -->
        <Condition>(private.enforceMTLSOnly = "true") and (hostHeaderMatchesMTLSHostname != "true")</Condition>
    </Step>
    <Step>
        <Name>RF-CertificateFingerprintDoesNotMatch</Name>
        <!--  Check enforced only when using an mtls enabled hostname. In production, endpoints protected by HoK should ONLY be associated with an mtls enabled hostname.
              In non-production environments, endpoints are also associated with the default non-mtls hostname, and that enables a test environment without HoK enforcement 
              An non-prod endpoint accessed throught the standard endpoint will always fail this condition
        -->
        <Condition>(verifyHok = "true") and (hostHeaderMatchesMTLSHostname = "true") and (request.header.tls-client-cert-fingerprint != certFingerprintBoundToToken)</Condition>
    </Step>
</SharedFlow>